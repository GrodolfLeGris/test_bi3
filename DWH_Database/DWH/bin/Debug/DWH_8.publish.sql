/*
Deployment script for PROD_DWH

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "PROD_DWH"
:setvar DefaultFilePrefix "PROD_DWH"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL16.MSSQLDWH\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL16.MSSQLDWH\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (QUERY_CAPTURE_MODE = ALL, CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367), MAX_STORAGE_SIZE_MB = 100) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE = OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET TEMPORAL_HISTORY_RETENTION OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
PRINT N'Rename refactoring operation with key acf8135e-41b0-45a0-82ad-9183ee008dd0, 07b5f858-6409-4900-be39-eb45a67eca09 is skipped, element [dbo].[DIM_ACCOUNTING_ACCOUNT].[SITE_CODE] (SqlSimpleColumn) will not be renamed to ORGANIZATIONLVL3ID';


GO
PRINT N'Rename refactoring operation with key b397b013-b5fe-4dd6-944b-0ebb5d1d4599 is skipped, element [dbo].[DIM_ACCOUNTING_CLASSIFICATION].[SITE_CODE] (SqlSimpleColumn) will not be renamed to ORGANIZATIONLVL3ID';


GO
PRINT N'Rename refactoring operation with key f99acf82-854d-46a4-a286-eb10bd1a47d9 is skipped, element [dbo].[DIM_COMMON_CUSTOMER].[SITE_CODE] (SqlSimpleColumn) will not be renamed to ORGANIZATIONLVL3ID';


GO
PRINT N'Rename refactoring operation with key 0034d18b-f824-4601-9ec7-8f2c6333ed59, be033338-c581-48ae-9e52-a93a7ae9c350 is skipped, element [dbo].[DIM_COMMON_BUILDING].[SITE] (SqlSimpleColumn) will not be renamed to ORGANIZATIONLVL1ID';


GO
PRINT N'Rename refactoring operation with key f195a9f6-0daf-437b-a5eb-0d0ba7b49619 is skipped, element [dbo].[DIM_COMMON_SITE].[BUSINESS_UNIT] (SqlSimpleColumn) will not be renamed to ORGANIZATIONLVL3ID';


GO
PRINT N'Rename refactoring operation with key 22c1b56c-ca4d-4c9d-9e27-31ebde85b3e9 is skipped, element [dbo].[DIM_COMMON_ACTIVITY].[ORGANIZATIONLVL2ID] (SqlSimpleColumn) will not be renamed to ORGANIZATIONLVL1ID';


GO
PRINT N'Creating Login [PROD_DWH_USER]...';


GO
CREATE LOGIN [PROD_DWH_USER]
    WITH PASSWORD = N'FWE6s+bc8rbU4di1Q0wt+Sii4qI/DQv0UiSsqfy7ljs=';


GO
ALTER LOGIN [PROD_DWH_USER] DISABLE;


GO
PRINT N'Creating User [PROD_DWH_User]...';


GO
CREATE USER [PROD_DWH_User] FOR LOGIN [PROD_DWH_USER];


GO
REVOKE CONNECT TO [PROD_DWH_User];


GO
PRINT N'Creating Role Membership [db_datareader] for [PROD_DWH_User]...';


GO
EXECUTE sp_addrolemember @rolename = N'db_datareader', @membername = N'PROD_DWH_User';


GO
PRINT N'Creating Role Membership [db_datawriter] for [PROD_DWH_User]...';


GO
EXECUTE sp_addrolemember @rolename = N'db_datawriter', @membername = N'PROD_DWH_User';


GO
PRINT N'Creating Table [dbo].[DIM_ACCOUNTING_ACCOUNT]...';


GO
CREATE TABLE [dbo].[DIM_ACCOUNTING_ACCOUNT] (
    [ORGANIZATIONLVL3ID] INT           NOT NULL,
    [ACCOUNT_NO]         NVARCHAR (20) NOT NULL,
    [ACCOUNT_NAME]       NVARCHAR (60) NULL,
    [BASE_NO]            NVARCHAR (10) NULL,
    [COST_CENTER_NO]     NVARCHAR (10) NULL,
    [LOCATION_NO]        NVARCHAR (10) NULL,
    [CATEGORY_TYPE]      NVARCHAR (20) NULL,
    [CLASSIFICATION]     NVARCHAR (40) NULL,
    CONSTRAINT [PK_DIM_ACCOUNTING_ACCOUNT_1] PRIMARY KEY CLUSTERED ([ORGANIZATIONLVL3ID] ASC, [ACCOUNT_NO] ASC)
);


GO
PRINT N'Creating Table [dbo].[DIM_ACCOUNTING_CLASSIFICATION]...';


GO
CREATE TABLE [dbo].[DIM_ACCOUNTING_CLASSIFICATION] (
    [ORGANIZATIONLVL3ID] INT           NOT NULL,
    [ACCOUNT_NO]         NVARCHAR (20) NOT NULL,
    [CLASSIFICATION]     NVARCHAR (40) NULL,
    CONSTRAINT [PK_DIM_ACCOUNTING_CLASSIFICATION] PRIMARY KEY CLUSTERED ([ORGANIZATIONLVL3ID] ASC, [ACCOUNT_NO] ASC)
);


GO
PRINT N'Creating Table [dbo].[DIM_COMMON_ACTIVITY]...';


GO
CREATE TABLE [dbo].[DIM_COMMON_ACTIVITY] (
    [ORGANIZATIONLVL1ID]  INT           NOT NULL,
    [ACTIVITY_SHORT_NAME] NVARCHAR (10) NOT NULL,
    [ACTIVITY_NAME]       NVARCHAR (50) NOT NULL,
    CONSTRAINT [PK_ACTIVITY] PRIMARY KEY CLUSTERED ([ORGANIZATIONLVL1ID] ASC, [ACTIVITY_SHORT_NAME] ASC)
);


GO
PRINT N'Creating Table [dbo].[DIM_COMMON_BUILDING]...';


GO
CREATE TABLE [dbo].[DIM_COMMON_BUILDING] (
    [BUILDING_KEY]       INT           NOT NULL,
    [BUILDING_CODE]      NVARCHAR (50) NULL,
    [ORGANIZATIONLVL1ID] INT           NULL,
    CONSTRAINT [PK_DIM_BUILDING] PRIMARY KEY CLUSTERED ([BUILDING_KEY] ASC)
);


GO
PRINT N'Creating Table [dbo].[DIM_COMMON_BUSINESS_UNIT]...';


GO
CREATE TABLE [dbo].[DIM_COMMON_BUSINESS_UNIT] (
    [ORGANIZATIONLVL2ID]       INT           NOT NULL,
    [BUSINESS_UNIT_SHORT_NAME] NVARCHAR (10) NOT NULL,
    [BUSINESS_UNIT]            NVARCHAR (50) NOT NULL,
    [ACTIVITY_NAME]            NVARCHAR (50) NULL,
    [ORGANIZATIONLVL1ID]       INT           NULL,
    CONSTRAINT [PK_DIM_BUSINESS_UNIT] PRIMARY KEY CLUSTERED ([ORGANIZATIONLVL2ID] ASC, [BUSINESS_UNIT_SHORT_NAME] ASC)
);


GO
PRINT N'Creating Table [dbo].[DIM_COMMON_CUSTOMER]...';


GO
CREATE TABLE [dbo].[DIM_COMMON_CUSTOMER] (
    [ORGANIZATIONLVL3ID] INT          NULL,
    [CUSTOMER_NO]        INT          NOT NULL,
    [CUSTOMER_CODE]      VARCHAR (50) NULL,
    [NAME]               VARCHAR (75) NULL,
    [CUSTOMER_TYPE]      VARCHAR (50) NULL,
    [CUSTOMER_STATUS]    BIT          NULL,
    CONSTRAINT [PK_DIM_COMMON_CUSTOMER_1] PRIMARY KEY CLUSTERED ([CUSTOMER_NO] ASC)
);


GO
PRINT N'Creating Table [dbo].[DIM_COMMON_SITE]...';


GO
CREATE TABLE [dbo].[DIM_COMMON_SITE] (
    [ORGANIZATIONLVL3ID] INT           NOT NULL,
    [SITE_CODE]          NVARCHAR (20) NOT NULL,
    [SITE]               NVARCHAR (50) NOT NULL,
    [SITE_SHORT_NAME]    NVARCHAR (10) NULL,
    [ORGANIZATIONLVL2ID] INT           NULL,
    [COUNTRY]            NVARCHAR (50) NULL,
    [STATE]              NVARCHAR (50) NULL,
    [PLEXUS_CUSTOMER_NO] INT           NULL,
    CONSTRAINT [PK_DIM_COMMON_SITE] PRIMARY KEY CLUSTERED ([ORGANIZATIONLVL3ID] ASC, [SITE_CODE] ASC)
);


GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'acf8135e-41b0-45a0-82ad-9183ee008dd0')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('acf8135e-41b0-45a0-82ad-9183ee008dd0')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '07b5f858-6409-4900-be39-eb45a67eca09')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('07b5f858-6409-4900-be39-eb45a67eca09')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'b397b013-b5fe-4dd6-944b-0ebb5d1d4599')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('b397b013-b5fe-4dd6-944b-0ebb5d1d4599')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f99acf82-854d-46a4-a286-eb10bd1a47d9')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f99acf82-854d-46a4-a286-eb10bd1a47d9')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '0034d18b-f824-4601-9ec7-8f2c6333ed59')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('0034d18b-f824-4601-9ec7-8f2c6333ed59')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f195a9f6-0daf-437b-a5eb-0d0ba7b49619')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f195a9f6-0daf-437b-a5eb-0d0ba7b49619')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'be033338-c581-48ae-9e52-a93a7ae9c350')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('be033338-c581-48ae-9e52-a93a7ae9c350')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '22c1b56c-ca4d-4c9d-9e27-31ebde85b3e9')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('22c1b56c-ca4d-4c9d-9e27-31ebde85b3e9')

GO

GO
PRINT N'Update complete.';


GO
